<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene & Weather Viewer - Verdigris MWE</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
            background: #222;
            color: #fff;
        }
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 14px;
            line-height: 1.4;
        }
        .controls h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .controls div {
            margin: 5px 0;
        }
        .key {
            color: #FFD700;
            font-weight: bold;
        }
        .current {
            color: #00FFFF;
        }
        canvas {
            display: block;
            margin: 20px auto;
            border: 2px solid #444;
            background: #111;
        }
        .info {
            text-align: center;
            margin: 20px;
            font-size: 16px;
        }
        .weather-effects {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 12px;
        }
        .tool-palette {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-width: 300px;
        }
        .tool-palette h4 {
            width: 100%;
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 12px;
        }
        .tool-button {
            width: 24px;
            height: 24px;
            border: 2px solid #666;
            background: #222;
            cursor: pointer;
            position: relative;
            border-radius: 3px;
            image-rendering: pixelated;
        }
        .tool-button.active {
            border-color: #FFD700;
            box-shadow: 0 0 8px #FFD700;
        }
        .tool-button:hover {
            border-color: #AAA;
        }
        .placed-effects {
            position: fixed;
            bottom: 10px;
            right: 120px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 12px;
        }
        canvas {
            cursor: crosshair;
        }
        canvas.tool-none {
            cursor: default;
        }
        .clear-effects {
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 8px;
        }
        .clear-effects:hover {
            background: #666;
        }
    </style>
    <script type="module" src="./weather_viewer.ts"></script>
</head>
<body>
    <div class="controls">
        <h3>üé¨ Scene & Weather Viewer</h3>
        <div><span class="key">‚Üê‚Üí</span> Change Background: <span class="current" id="bg-name">toyforge</span></div>
        <div><span class="key">‚Üë‚Üì</span> Change Weather: <span class="current" id="weather-name">clear</span></div>
        <div><span class="key">V</span> Toggle View: <span class="current" id="view-name">isometric</span></div>
        <div><span class="key">Space</span> Play/Pause</div>
        <div><span class="key">R</span> Reset Scene</div>
        <div><span class="key">Click</span> Place Effect</div>
        <div><span class="key">C</span> Clear Effects</div>
    </div>
    
    <div class="weather-effects">
        <h4>‚õÖ Weather Effects</h4>
        <div>Particles: <span id="particle-count">0</span></div>
        <div>Temperature: <span id="temperature">20</span>¬∞</div>
        <div>Humidity: <span id="humidity">0.5</span></div>
        <div>Wind: <span id="wind">none</span></div>
    </div>

    <div class="info">
        <h2>üåç Background & Weather Testing Environment</h2>
        <p>Use arrow keys to test different background/weather combinations</p>
    </div>

    <canvas id="gameCanvas" width="320" height="200"></canvas>
    
    <div class="tool-palette" id="toolPalette">
        <h4>üé® Cell Effects Toolkit</h4>
    </div>
    
    <div class="placed-effects">
        <h4>üìç Placed Effects</h4>
        <div>Active: <span id="effect-count">0</span></div>
        <div>Current Tool: <span id="current-tool">none</span></div>
        <button class="clear-effects" onclick="clearAllEffects()">Clear All</button>
    </div>
    
    <script>
        // Cell Effects Tool System
        class CellEffectsToolkit {
            constructor() {
                this.cellEffectsImage = new Image();
                this.cellEffectsImage.src = '../assets/cell-effects.png';
                this.currentTool = 0;
                this.placedEffects = [];
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // Effect definitions based on the sprite sheet
                this.effects = [
                    { name: 'none', icon: '‚úã', x: 0, y: 0 },
                    { name: 'fire', icon: 'üî•', x: 0, y: 0 },
                    { name: 'explosion', icon: 'üí•', x: 16, y: 0 },
                    { name: 'ice', icon: '‚ùÑÔ∏è', x: 32, y: 0 },
                    { name: 'lightning', icon: '‚ö°', x: 48, y: 0 },
                    { name: 'poison', icon: '‚ò†Ô∏è', x: 64, y: 0 },
                    { name: 'heal', icon: 'üíö', x: 80, y: 0 },
                    { name: 'shield', icon: 'üõ°Ô∏è', x: 96, y: 0 },
                    { name: 'hover', icon: 'üîç', x: 112, y: 0 }
                ];
                
                this.setupToolPalette();
                this.setupCanvasInteraction();
                this.setupKeyboardControls();
                this.updateCurrentTool();
            }
            
            setupToolPalette() {
                const palette = document.getElementById('toolPalette');
                
                this.effects.forEach((effect, index) => {
                    const button = document.createElement('div');
                    button.className = 'tool-button';
                    button.title = effect.name;
                    button.setAttribute('data-tool', index);
                    
                    if (index === 0) {
                        // None tool - just show icon
                        button.textContent = effect.icon;
                        button.style.fontSize = '14px';
                        button.style.lineHeight = '20px';
                        button.style.textAlign = 'center';
                    } else {
                        // Create canvas for sprite preview
                        const preview = document.createElement('canvas');
                        preview.width = 20;
                        preview.height = 20;
                        const previewCtx = preview.getContext('2d');
                        
                        this.cellEffectsImage.onload = () => {
                            previewCtx.imageSmoothingEnabled = false;
                            previewCtx.drawImage(
                                this.cellEffectsImage, 
                                effect.x, effect.y, 16, 16,
                                2, 2, 16, 16
                            );
                        };
                        
                        button.appendChild(preview);
                    }
                    
                    button.addEventListener('click', () => {
                        this.setCurrentTool(index);
                    });
                    
                    palette.appendChild(button);
                });
            }
            
            setupCanvasInteraction() {
                this.canvas.addEventListener('click', (event) => {
                    if (this.currentTool === 0) return; // None tool
                    
                    const rect = this.canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    // Convert to grid coordinates (assuming 16x16 cells)
                    const gridX = Math.floor(x / 16);
                    const gridY = Math.floor(y / 16);
                    
                    this.placeEffect(gridX, gridY, this.currentTool);
                });
            }
            
            setupKeyboardControls() {
                document.addEventListener('keydown', (event) => {
                    switch(event.key) {
                        case 'c':
                        case 'C':
                            this.clearAllEffects();
                            event.preventDefault();
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                        case '7':
                        case '8':
                        case '9':
                            const toolIndex = parseInt(event.key);
                            if (toolIndex <= this.effects.length) {
                                this.setCurrentTool(toolIndex - 1);
                                event.preventDefault();
                            }
                            break;
                    }
                });
            }
            
            setCurrentTool(toolIndex) {
                this.currentTool = toolIndex;
                this.updateCurrentTool();
                this.updateToolButtons();
                this.updateCanvasCursor();
            }
            
            updateCurrentTool() {
                const toolName = this.effects[this.currentTool].name;
                document.getElementById('current-tool').textContent = toolName;
            }
            
            updateToolButtons() {
                document.querySelectorAll('.tool-button').forEach((button, index) => {
                    button.classList.toggle('active', index === this.currentTool);
                });
            }
            
            updateCanvasCursor() {
                if (this.currentTool === 0) {
                    this.canvas.classList.add('tool-none');
                    this.canvas.classList.remove('crosshair');
                } else {
                    this.canvas.classList.remove('tool-none');
                    this.canvas.classList.add('crosshair');
                }
            }
            
            placeEffect(gridX, gridY, effectIndex) {
                // Remove existing effect at this position
                this.placedEffects = this.placedEffects.filter(
                    effect => !(effect.gridX === gridX && effect.gridY === gridY)
                );
                
                // Add new effect
                const effect = {
                    gridX,
                    gridY,
                    effectIndex,
                    timestamp: Date.now()
                };
                
                this.placedEffects.push(effect);
                this.updateEffectCount();
                this.renderEffects();
            }
            
            clearAllEffects() {
                this.placedEffects = [];
                this.updateEffectCount();
                this.renderEffects();
            }
            
            updateEffectCount() {
                document.getElementById('effect-count').textContent = this.placedEffects.length;
            }
            
            renderEffects() {
                // This would integrate with the main rendering loop
                // For now, we'll draw effects directly on canvas
                requestAnimationFrame(() => {
                    this.drawEffectsOverlay();
                });
            }
            
            drawEffectsOverlay() {
                if (!this.cellEffectsImage.complete) return;
                
                // Save current state
                this.ctx.save();
                
                // Draw each placed effect
                this.placedEffects.forEach(effect => {
                    const effectData = this.effects[effect.effectIndex];
                    const screenX = effect.gridX * 16;
                    const screenY = effect.gridY * 16;
                    
                    // Add slight animation based on timestamp
                    const age = (Date.now() - effect.timestamp) / 1000;
                    const pulse = Math.sin(age * 3) * 0.1 + 1;
                    
                    this.ctx.save();
                    this.ctx.translate(screenX + 8, screenY + 8);
                    this.ctx.scale(pulse, pulse);
                    this.ctx.translate(-8, -8);
                    
                    this.ctx.imageSmoothingEnabled = false;
                    this.ctx.drawImage(
                        this.cellEffectsImage,
                        effectData.x, effectData.y, 16, 16,
                        0, 0, 16, 16
                    );
                    
                    this.ctx.restore();
                });
                
                this.ctx.restore();
            }
        }
        
        // Global function for clear button
        function clearAllEffects() {
            if (window.cellEffectsToolkit) {
                window.cellEffectsToolkit.clearAllEffects();
            }
        }
        
        // Initialize toolkit when page loads
        window.addEventListener('load', () => {
            window.cellEffectsToolkit = new CellEffectsToolkit();
        });
    </script>
</body>
</html>